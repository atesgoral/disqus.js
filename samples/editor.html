<html>
<head>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
var user_key;

function setForumList(data) {
    var forums = $("#forums");

    $.each(data.message, function (i, forum) {
        forums.append($('<li><a href="#" id="' + forum.id + '">'
            + forum.name
            + '</a></li>'));
    });
}

function setForumApiKey(data) {
    var forum_key = data.message;
    $("#forum_api_key").val(forum_key);
    
    $.ajax({
        url: "http://disqus.com/api/get_thread_list/",
        dataType: "script",
        data: {
            forum_api_key: forum_key,
            api_response_format: "jsonp:setDiscussionList"
        }
    });
}

function setDiscussionList(data) {
    var discussions = $("#discussions");
    
    discussions.empty();
    
    $.each(data.message, function (i, discussion) {
        discussions.append($('<li><a href="' + discussion.url
            + '">'
            + discussion.title
            + '</a>'
            + ' <input type="text" size="64" value="'
            + discussion.url
            + '" id="' + discussion.id + '"/>'
            + '</li>'));
    });
}

function setUpdateThreadUrlSuccess() {
    alert("yay");
}

function updateThreadUrl(thread_id, url) {
    $("#thread_id").val(thread_id);
    $("#url").val(url);
    $("#form").submit();
}

function selectForum(forum_id) {
    $.ajax({
        url: "http://disqus.com/api/get_forum_api_key/",
        dataType: "script",
        data: {
            user_api_key: user_key,
            forum_id: forum_id,
            api_response_format: "jsonp:setForumApiKey"
        }
    });
}

function setUserKey(user_key) {
    window.user_key = user_key;
    
    $.ajax({
        url: "http://disqus.com/api/get_forum_list/",
        dataType: "script",
        data: {
            user_api_key: user_key,
            api_response_format: "jsonp:setForumList"
        }
    });
}

$(function () {
    $("#user_key").keypress(function (e) {
        if ((e.keyCode || e.which) == 13) {
            setUserKey(this.value);
        }
    }).val(document.location.search.replace("?", ""));
    
    $("#forums").click(function (e) {
        selectForum(e.target.id);
    });
    
    $("#discussions").keypress(function (e) {
        if ((e.keyCode || e.which) == 13) {
            updateThreadUrl(e.target.id, e.target.value);
        }
    });   
});
</script>
</head>
<body>
<h4>Enter user key</h4>
<input type="text" size="64" id="user_key"/>
<h4>Select forum</h4>
<ol id="forums">
</ol>
<h4>Discussions</h4>
<ol id="discussions">
</ol>
<div style="display: none">
<form id="form" method="post" target="post_target" action="http://disqus.com/api/update_thread/">
<input type="hidden" name="forum_api_key" id="forum_api_key"/>
<input type="hidden" name="thread_id" id="thread_id"/>
<input type="hidden" name="url" id="url"/>
<input type="hidden" name="api_response_format" value="jsonp:dummy"/>
</form>
<iframe name="post_target"></iframe>
</div>
</body>
</html>
